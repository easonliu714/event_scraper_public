<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ç£æ´»å‹•æƒ…å ±é›·é” ğŸ“¡</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #3b82f6; --chip-bg: #2a2a2a; }
        body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); padding-bottom: 60px; overscroll-behavior-y: contain; }
        
        #pull-to-refresh {
            position: fixed; top: -50px; left: 0; width: 100%; height: 50px;
            display: flex; justify-content: center; align-items: center;
            color: var(--accent); font-size: 1.2rem; transition: top 0.2s; z-index: 200;
        }
        #pull-to-refresh.visible { top: 60px; }
        .spinner { animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        header { position: sticky; top: 0; z-index: 100; background: rgba(18,18,18,0.95); backdrop-filter: blur(10px); padding: 12px 16px; border-bottom: 1px solid #333; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        h1 { margin: 0; font-size: 1.2rem; }
        .header-actions { display: flex; gap: 12px; }
        .action-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #aaa; transition: 0.2s; }
        .action-btn:hover { color: #fff; }

        .search-box { width: 100%; padding: 12px; border-radius: 12px; background: #2a2a2a; border: 1px solid #333; color: #fff; font-size: 1rem; }
        
        .filter-section { padding: 16px; background: #181818; border-bottom: 1px solid #333; }
        .filter-block { margin-bottom: 16px; }
        .block-title { font-size: 0.85rem; color: #888; margin-bottom: 8px; }
        .chips { display: flex; flex-wrap: wrap; gap: 8px; }
        .chip { padding: 6px 12px; background: var(--chip-bg); border-radius: 8px; font-size: 0.9rem; cursor: pointer; border: 1px solid #333; transition: 0.2s; display: flex; gap: 6px; }
        .chip span { opacity: 0.6; font-size: 0.8em; }
        .chip.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        .chip.active span { opacity: 1; color: #fff; }
        
        .list-header { padding: 12px 16px; font-size: 0.9rem; color: #aaa; background: #121212; border-bottom: 1px solid #222; }
        .list-info-row { display: flex; justify-content: space-between; align-items: center; }
        .disclaimer { font-size: 0.75rem; color: #666; margin-top: 6px; padding-top: 6px; border-top: 1px solid #333; text-align: right; }
        
        #event-list { max-width: 800px; margin: 0 auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; min-height: 300px; }
        .card { background: var(--card); border-radius: 12px; padding: 12px; display: flex; gap: 12px; border: 1px solid #333; }
        .card.read { opacity: 0.6; }
        .card-img { width: 90px; height: 90px; border-radius: 8px; background: #333; object-fit: cover; }
        .card-info { flex: 1; display: flex; flex-direction: column; gap: 4px; }
        .badges { display: flex; flex-wrap: wrap; gap: 4px; font-size: 0.75rem; }
        .badge { padding: 2px 6px; border-radius: 4px; background: #333; color: #ccc; }
        .badge.new { background: #ef4444; color: #fff; }
        .badge.fav { background: #f59e0b; color: #fff; }
        
        .pagination { display: flex; justify-content: center; align-items: center; gap: 16px; margin: 20px 0; }
        .page-btn { padding: 8px 16px; background: #333; border: none; color: #fff; border-radius: 8px; cursor: pointer; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 200; display: none; justify-content: center; align-items: end; }
        .modal-overlay.open { display: flex; }
        .modal { background: #222; width: 100%; max-width: 600px; padding: 24px; border-radius: 20px 20px 0 0; max-height: 90vh; overflow-y: auto; }
        
        .settings-panel { padding: 16px; background: #2a2a2a; border-radius: 12px; margin-bottom: 16px; }
        .keyword-input { width: 100%; padding: 10px; border-radius: 8px; background: #121212; border: 1px solid #444; color: #fff; margin-bottom: 8px; }
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag { background: #444; padding: 4px 10px; border-radius: 16px; font-size: 0.85rem; display: flex; gap: 6px; }
    </style>
</head>
<body>

<div id="pull-to-refresh">
    <span id="ptr-icon">â¬‡ï¸ ä¸‹æ‹‰æ›´æ–°</span>
    <span id="ptr-spinner" class="spinner">ğŸ”„</span>
</div>

<header>
    <div class="top-bar">
        <h1>ğŸ“¡ æ´»å‹•é›·é”</h1>
        <div class="header-actions">
            <button class="action-btn" onclick="markAllRead()" title="å…¨éƒ¨è¨­ç‚ºå·²è®€">âœ…</button>
            <button class="action-btn" onclick="openSettings()" title="è¨­å®š">âš™ï¸</button>
        </div>
    </div>
    <input type="text" id="search" class="search-box" placeholder="æœå°‹é—œéµå­—..." oninput="resetPageAndRender()">
</header>

<div class="filter-section">
    <div class="filter-block">
        <div class="block-title">ğŸ›ï¸ å¹³å°ç¯©é¸</div>
        <div id="platform-chips" class="chips"></div>
    </div>
    
    <div class="filter-block">
        <div class="block-title">ğŸ“ åœ°å€ç¯©é¸ (å«è¯é›†ï¼Œæœªå®šå€åŸŸè‡ªå‹•ä¿ç•™)</div>
        <div id="region-chips" class="chips">
            <div class="chip" onclick="toggleFilter('regions', 'north', this)">åŒ—å€</div>
            <div class="chip" onclick="toggleFilter('regions', 'central', this)">ä¸­å€</div>
            <div class="chip" onclick="toggleFilter('regions', 'south', this)">å—å€</div>
            <div class="chip" onclick="toggleFilter('regions', 'east', this)">æ±å€</div>
            <div class="chip" onclick="toggleFilter('regions', 'islands', this)">é›¢å³¶</div>
        </div>
    </div>

    <div class="filter-block">
        <div class="block-title">âœ¨ ç‹€æ…‹ç¯©é¸</div>
        <div class="chips" id="status-chips"></div>
    </div>
    <div class="filter-block">
        <div class="block-title">ğŸ·ï¸ é¡åˆ¥ç¯©é¸</div>
        <div id="type-chips" class="chips"></div>
    </div>
</div>

<div class="list-header">
    <div class="list-info-row">
        <span id="result-count">é¡¯ç¤º 0 ç­†æ´»å‹•</span>
        <span id="update-time" style="font-size:0.8em">æ›´æ–°æ–¼: ...</span>
    </div>
    <div class="disclaimer">âš ï¸ æ´»å‹•åˆ—è¡¨åƒ…ä¾›åƒè€ƒï¼Œæ´»å‹•å…§å®¹ä»¥å„å¹³å°è³‡è¨Šç‚ºæº–ã€‚</div>
</div>

<div id="event-list"></div>

<div class="pagination">
    <button class="page-btn" onclick="changePage(-1)" id="prev-btn">â—€ ä¸Šä¸€é </button>
    <span id="page-info">ç¬¬ 1 / 1 é </span>
    <button class="page-btn" onclick="changePage(1)" id="next-btn">ä¸‹ä¸€é  â–¶</button>
</div>

<div class="modal-overlay" id="detail-modal" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <img id="m-img" style="width:100%; max-height:250px; object-fit:cover; border-radius:12px; margin-bottom:16px; display:none;">
        
        <div style="margin-bottom:8px;">
            <span id="m-platform" class="badge" style="background:#333; color:#60a5fa; padding:4px 8px; border-radius:4px; font-size:0.8rem;"></span>
            <span id="m-type" class="badge" style="background:#333; color:#ccc; padding:4px 8px; border-radius:4px; font-size:0.8rem;"></span>
        </div>

        <h2 id="m-title" style="margin-bottom:15px; line-height: 1.4;"></h2>
        
        <div style="background: #2a2a2a; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 0.95rem;">
            <div style="margin-bottom: 6px;">ğŸ“… <b>æ—¥æœŸï¼š</b><span id="m-date" style="color:#ddd"></span></div>
            <div style="margin-bottom: 6px;">ğŸ“ <b>åœ°é»ï¼š</b><span id="m-location" style="color:#ddd"></span></div>
            <div>ğŸ’° <b>ç¥¨åƒ¹ï¼š</b><span id="m-price" style="color:#ddd"></span></div>
        </div>

        <div style="margin-bottom: 20px;">
            <h4 style="margin: 0 0 8px 0; color: #888; font-size: 0.9rem;">ğŸ“ æ´»å‹•ç°¡ä»‹</h4>
            <p id="m-desc" style="color: #ccc; font-size: 0.95rem; line-height: 1.6; white-space: pre-line; max-height: 300px; overflow-y: auto;"></p>
        </div>

        <a id="m-link" href="#" target="_blank" style="display:block; padding:12px; background:#3b82f6; color:#fff; text-align:center; border-radius:8px; text-decoration:none; font-weight:bold;">å‰å¾€å®˜ç¶²æŸ¥çœ‹è©³æƒ…</a>
    </div>
</div>

<div class="modal-overlay" id="settings-modal" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <h2>âš™ï¸ è¨­å®š</h2>
        
        <div class="settings-panel">
            <div class="block-title">ğŸ”” é€šçŸ¥è¨­å®š</div>
            <button onclick="requestNotifyPermission()" style="width:100%; padding:10px; background:#333; color:#fff; border:none; border-radius:8px; margin-top:8px;">
                æª¢æŸ¥é€šçŸ¥æ¬Šé™
            </button>
            <p id="notify-status" style="font-size:0.8rem; color:#888; margin-top:8px; text-align:center;">
                ç‹€æ…‹: æœªçŸ¥
            </p>
            <p style="font-size:0.75rem; color:#666; margin-top:4px; line-height:1.4;">
                âš ï¸ PWA é™åˆ¶ï¼šç¶²é å¿…é ˆåœ¨é–‹å•Ÿç‹€æ…‹ä¸‹(æˆ–ä¸‹æ‹‰åˆ·æ–°æ™‚)æ‰èƒ½è§¸ç™¼é€šçŸ¥ã€‚
            </p>
        </div>

        <div class="settings-panel">
            <label>â­ é—œæ³¨é—œéµå­— (æŒ‰ Enter æ–°å¢)</label>
            <input type="text" id="keyword-input" class="keyword-input">
            <div id="keywords-tags" class="tags-container"></div>
        </div>
    </div>
</div>

<script>
    let allEvents = [];
    let filteredEvents = [];
    let currentPage = 1;
    const PAGE_SIZE = 50;
    
    // [ä¿®æ”¹] å¢åŠ  regions ç¯©é¸å™¨
    const filters = { platforms: new Set(), status: new Set(), types: new Set(), regions: new Set() };
    let myKeywords = JSON.parse(localStorage.getItem('myKeywords') || '[]');
    let readEvents = JSON.parse(localStorage.getItem('readEvents') || '[]');

    // åœ°å€å®šç¾©
    const regionMap = {
        'north': ['å°åŒ—', 'æ–°åŒ—', 'åŸºéš†', 'æ¡ƒåœ’', 'æ–°ç«¹', 'å®œè˜­'],
        'central': ['è‹—æ —', 'å°ä¸­', 'å½°åŒ–', 'å—æŠ•', 'é›²æ—'],
        'south': ['å˜‰ç¾©', 'å°å—', 'é«˜é›„', 'å±æ±'],
        'east': ['èŠ±è“®', 'å°æ±'],
        'islands': ['æ¾æ¹–', 'é‡‘é–€', 'é¦¬ç¥–']
    };

    // ä¸‹æ‹‰æ›´æ–°é‚è¼¯ (ä¿æŒä¸è®Š)
    let touchStartY = 0;
    const ptrEl = document.getElementById('pull-to-refresh');
    const ptrIcon = document.getElementById('ptr-icon');
    const ptrSpinner = document.getElementById('ptr-spinner');

    window.addEventListener('touchstart', e => { if (window.scrollY === 0) touchStartY = e.touches[0].clientY; });
    window.addEventListener('touchmove', e => {
        if (window.scrollY === 0 && e.touches[0].clientY > touchStartY) {
            if (e.touches[0].clientY - touchStartY > 60) {
                ptrEl.style.top = '60px'; ptrIcon.style.display = 'block'; ptrSpinner.style.display = 'none';
            }
        }
    });
    window.addEventListener('touchend', async e => {
        if (ptrEl.style.top === '60px') {
            ptrIcon.style.display = 'none'; ptrSpinner.style.display = 'block';
            await init();
            setTimeout(() => { ptrEl.style.top = '-50px'; }, 500);
        }
    });

    async function init() {
        checkNotifyStatus();
        
        // é‡è©¦æ©Ÿåˆ¶ (è§£æ±º CDN å»¶é²)
        const maxRetries = 3;
        let attempt = 0;
        let success = false;

        while (attempt < maxRetries && !success) {
            try {
                const timestamp = Date.now();
                const res = await fetch(`data.json?t=${timestamp}`, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });

                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                
                allEvents = await res.json();
                allEvents.sort((a,b) => new Date(b.scraped_at) - new Date(a.scraped_at));
                
                const latestTime = allEvents[0]?.scraped_at;
                const lastKnownTime = localStorage.getItem('lastDataTime');
                if (latestTime && latestTime !== lastKnownTime) {
                    localStorage.setItem('lastDataTime', latestTime);
                    checkAndNotifyNewFavs();
                }

                document.getElementById('update-time').textContent = `æ›´æ–°æ–¼: ${new Date(allEvents[0]?.scraped_at).toLocaleString()}`;
                
                document.getElementById('event-list').innerHTML = ''; 
                renderChips();
                applyFilters();
                success = true;

            } catch(e) {
                console.error(`Attempt ${attempt + 1} failed:`, e);
                attempt++;
                if (attempt < maxRetries) {
                    await new Promise(r => setTimeout(r, 1000));
                } else {
                    document.getElementById('event-list').innerHTML = `
                        <div style="text-align:center; padding:40px; color:#ff6b6b;">
                            <div style="font-size:3rem; margin-bottom:10px;">ğŸ“¡</div>
                            <div>é€£ç·šä¸ç©©æˆ–è³‡æ–™æ›´æ–°ä¸­</div>
                            <div style="font-size:0.8rem; opacity:0.7; margin-top:5px;">è«‹å˜—è©¦ä¸‹æ‹‰é é¢é‡æ–°æ•´ç†</div>
                        </div>`;
                }
            }
        }
    }

    function checkAndNotifyNewFavs() {
        if (Notification.permission !== "granted") return;
        const newFavs = allEvents.filter(e => !readEvents.includes(e.url) && checkIsFav(e.title));
        if (newFavs.length > 0) {
            new Notification("ğŸ“¡ æ´»å‹•é›·é”ï¼šç™¼ç¾é—œæ³¨æ´»å‹•ï¼", {
                body: `ç™¼ç¾ ${newFavs.length} ç­†æ–°çš„é—œæ³¨æ´»å‹•ï¼Œé»æ“ŠæŸ¥çœ‹ï¼`,
                icon: 'icons/icon-192.png',
                tag: 'fav-event-alert'
            });
        }
    }

    function markAllRead() {
        if(!confirm("ç¢ºå®šè¦å°‡æ‰€æœ‰æ´»å‹•è¨­ç‚ºå·²è®€å—ï¼Ÿ")) return;
        const currentUrls = allEvents.map(e => e.url);
        const uniqueReads = new Set([...readEvents, ...currentUrls]);
        readEvents = Array.from(uniqueReads);
        localStorage.setItem('readEvents', JSON.stringify(readEvents));
        updateStatusCounts();
        renderList();
    }

    function checkIsFav(title) {
        if (!title) return false;
        const t = title.toLowerCase();
        return myKeywords.some(k => t.includes(k.toLowerCase()));
    }

    function renderChips() {
        const pStats = {}; allEvents.forEach(e => pStats[e.platform] = (pStats[e.platform]||0)+1);
        document.getElementById('platform-chips').innerHTML = Object.entries(pStats).sort((a,b) => b[1]-a[1]).map(([k,v]) => `<div class="chip" onclick="toggleFilter('platforms', '${k}', this)">${k} <span>${v}</span></div>`).join('');

        const tStats = {}; allEvents.forEach(e => tStats[e.type] = (tStats[e.type]||0)+1);
        document.getElementById('type-chips').innerHTML = Object.entries(tStats).sort((a,b) => b[1]-a[1]).map(([k,v]) => `<div class="chip" onclick="toggleFilter('types', '${k}', this)">${k} <span>${v}</span></div>`).join('');

        updateStatusCounts();
    }

    function updateStatusCounts() {
        const newCount = allEvents.filter(e => !readEvents.includes(e.url)).length;
        const favCount = allEvents.filter(e => checkIsFav(e.title)).length;
        
        const isNewActive = filters.status.has('isNew') ? 'active' : '';
        const isFavActive = filters.status.has('isFav') ? 'active' : '';
        document.getElementById('status-chips').innerHTML = `
            <div class="chip ${isNewActive}" onclick="toggleFilter('status', 'isNew', this)">ğŸ†• æ–°é€²æ´»å‹• <span>${newCount}</span></div>
            <div class="chip ${isFavActive}" onclick="toggleFilter('status', 'isFav', this)">â­ é—œæ³¨é—œéµå­— <span>${favCount}</span></div>
        `;
    }

    function toggleFilter(category, value, el) {
        el.classList.toggle('active');
        if (filters[category].has(value)) filters[category].delete(value);
        else filters[category].add(value);
        resetPageAndRender();
    }

    function resetPageAndRender() { currentPage = 1; applyFilters(); }

    // [ä¿®æ”¹] è¼”åŠ©å‡½å¼ï¼šåˆ¤æ–·æ´»å‹•åœ°å€
    function getEventRegion(location) {
        if (!location || location.includes('è©³å…§æ–‡')) return 'unknown';
        for (const [key, keywords] of Object.entries(regionMap)) {
            if (keywords.some(k => location.includes(k))) return key;
        }
        return 'unknown';
    }

    function applyFilters() {
        const query = document.getElementById('search').value.toLowerCase();
        filteredEvents = allEvents.filter(e => {
            const isFav = checkIsFav(e.title);
            const isNew = !readEvents.includes(e.url);
            
            // é—œéµå­—æœå°‹
            if (query && !e.title.toLowerCase().includes(query)) return false;
            
            // å¹³å°ç¯©é¸
            if (filters.platforms.size > 0 && !filters.platforms.has(e.platform)) return false;
            
            // é¡åˆ¥ç¯©é¸
            if (filters.types.size > 0 && !filters.types.has(e.type)) return false;
            
            // ç‹€æ…‹ç¯©é¸
            if (filters.status.has('isNew') && !isNew) return false;
            if (filters.status.has('isFav') && !isFav) return false;

            // [æ–°å¢] åœ°å€ç¯©é¸é‚è¼¯
            if (filters.regions.size > 0) {
                const eventRegion = getEventRegion(e.location);
                // é‚è¼¯ï¼š
                // 1. å¦‚æœæ´»å‹•åœ°å€æ˜¯ unknownï¼Œå‰‡ä¿ç•™ (é¡¯ç¤º)
                // 2. å¦‚æœæ´»å‹•åœ°å€æ˜¯ knownï¼Œå‰‡å¿…é ˆåŒ…å«åœ¨ç”¨æˆ¶é¸æ“‡çš„ç¯©é¸å™¨ä¸­
                // ä¹Ÿå°±æ˜¯ï¼šä¿ç•™ (æ˜¯ unknown) OR (æ˜¯ selected)
                const isSelected = filters.regions.has(eventRegion);
                const isUnknown = eventRegion === 'unknown';
                
                if (!isUnknown && !isSelected) return false;
            }

            return true;
        });
        document.getElementById('result-count').textContent = `é¡¯ç¤º ${filteredEvents.length} ç­†æ´»å‹• (å…± ${allEvents.length} ç­†)`;
        renderList();
        renderPagination();
    }

    function renderList() {
        const start = (currentPage - 1) * PAGE_SIZE;
        const pageData = filteredEvents.slice(start, start + PAGE_SIZE);
        const list = document.getElementById('event-list');
        if(pageData.length === 0) { list.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ´»å‹• ğŸ¢</div>'; return; }
        list.innerHTML = pageData.map(e => {
            const isFav = checkIsFav(e.title);
            const isNew = !readEvents.includes(e.url);
            return `<div class="card ${!isNew ? 'read' : ''}" onclick="openDetail('${e.url}')">
                    ${e.img_url ? `<img src="${e.img_url}" class="card-img" loading="lazy">` : ''}
                    <div class="card-info">
                        <div class="badges"><span class="badge" style="color:#60a5fa">${e.platform}</span>${isNew ? '<span class="badge new">NEW</span>' : ''}${isFav ? '<span class="badge fav">â­ é—œæ³¨</span>' : ''}<span class="badge">${e.type}</span></div>
                        <div style="font-weight:500; font-size:1rem;">${e.title}</div>
                        <div style="font-size:0.8rem; color:#888;">${e.date || 'è©³å…§æ–‡'} ${e.location ? `| ${e.location}` : ''}</div>
                    </div></div>`;
        }).join('');
    }

    function renderPagination() {
        const totalPages = Math.ceil(filteredEvents.length / PAGE_SIZE) || 1;
        document.getElementById('page-info').textContent = `ç¬¬ ${currentPage} / ${totalPages} é `;
        document.getElementById('prev-btn').disabled = currentPage === 1;
        document.getElementById('next-btn').disabled = currentPage === totalPages;
    }

    function changePage(delta) { currentPage += delta; renderList(); renderPagination(); window.scrollTo(0, 0); }

    function openDetail(url) {
        const ev = allEvents.find(e => e.url === url);
        if(!ev) return;
        
        if(!readEvents.includes(url)) { 
            readEvents.push(url); 
            localStorage.setItem('readEvents', JSON.stringify(readEvents)); 
            updateStatusCounts(); 
        }

        document.getElementById('m-title').textContent = ev.title;
        document.getElementById('m-platform').textContent = ev.platform;
        document.getElementById('m-type').textContent = ev.type;
        document.getElementById('m-link').href = ev.url;
        
        document.getElementById('m-date').textContent = ev.date || 'è©³å…§æ–‡';
        document.getElementById('m-location').textContent = ev.location || 'è©³å…§æ–‡';
        document.getElementById('m-price').textContent = ev.price || 'è©³å…§æ–‡';
        
        const desc = ev.description ? ev.description : 'æš«ç„¡è©³ç´°ç°¡ä»‹ï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•å‰å¾€å®˜ç¶²æŸ¥çœ‹ã€‚';
        document.getElementById('m-desc').textContent = desc;

        const img = document.getElementById('m-img');
        if(ev.img_url) { 
            img.src = ev.img_url; 
            img.style.display = 'block'; 
        } else { 
            img.style.display = 'none'; 
        }

        document.getElementById('detail-modal').classList.add('open');
        renderList();
    }

    function closeModal() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('open')); }
    function openSettings() { renderKeywords(); checkNotifyStatus(); document.getElementById('settings-modal').classList.add('open'); }
    function renderKeywords() { document.getElementById('keywords-tags').innerHTML = myKeywords.map((k, i) => `<div class="tag">${k} <span onclick="removeKeyword(${i})" style="cursor:pointer; color:#f87171">Ã—</span></div>`).join(''); }
    function removeKeyword(i) { myKeywords.splice(i, 1); renderKeywords(); localStorage.setItem('myKeywords', JSON.stringify(myKeywords)); applyFilters(); updateStatusCounts(); }
    document.getElementById('keyword-input').onkeypress = (e) => { if(e.key === 'Enter') { const val = e.target.value.trim(); if(val && !myKeywords.includes(val)) { myKeywords.push(val); e.target.value = ''; renderKeywords(); localStorage.setItem('myKeywords', JSON.stringify(myKeywords)); applyFilters(); updateStatusCounts(); } } };
    
    function requestNotifyPermission() { 
        Notification.requestPermission().then(p => {
            alert(p === "granted" ? "âœ… é€šçŸ¥å·²é–‹å•Ÿ" : "ğŸš« é€šçŸ¥è¢«æ‹’çµ•");
            checkNotifyStatus();
        }); 
    }
    
    function checkNotifyStatus() {
        const p = Notification.permission;
        const statusMap = { 'default': 'æœªè©¢å•', 'granted': 'âœ… å·²é–‹å•Ÿ', 'denied': 'ğŸš« å·²å°é–' };
        document.getElementById('notify-status').textContent = `ç‹€æ…‹: ${statusMap[p] || p}`;
    }

    init();
</script>
</body>
</html>
