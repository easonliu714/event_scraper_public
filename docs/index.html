<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ç£æ´»å‹•æƒ…å ±é›·é” ğŸ‡¹ğŸ‡¼</title>
    <meta name="description" content="è‡ªå‹•å½™æ•´å…¨å°å„å¤§å”®ç¥¨ç¶²èˆ‡æ´»å‹•å¹³å°çš„æœ€æ–°æƒ…å ±">
    
    <meta name="theme-color" content="#1a1a1a">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“¡</text></svg>">

    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sub: #a0a0a0;
            --accent: #3b82f6;
            --new-badge: #ef4444;
            --fav-badge: #f59e0b;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-color); color: var(--text-main); padding-bottom: 80px; }
        
        /* é ‚éƒ¨å°èˆª */
        header { position: sticky; top: 0; background: rgba(18,18,18,0.95); backdrop-filter: blur(10px); z-index: 100; padding: 12px 16px; border-bottom: 1px solid #333; }
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        h1 { margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; }
        .tools { display: flex; gap: 12px; }
        button { background: none; border: none; color: var(--text-main); font-size: 1.2rem; cursor: pointer; padding: 4px; }
        
        /* æœå°‹èˆ‡éæ¿¾ */
        .filter-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
        .filter-row::-webkit-scrollbar { display: none; }
        .search-box { flex: 1; background: #2a2a2a; border: none; padding: 8px 12px; border-radius: 20px; color: #fff; font-size: 0.95rem; outline: none; min-width: 150px; }
        .chip { white-space: nowrap; padding: 6px 12px; border-radius: 16px; background: #2a2a2a; color: #ccc; font-size: 0.85rem; border: 1px solid #333; cursor: pointer; transition: 0.2s; }
        .chip.active { background: var(--accent); color: #fff; border-color: var(--accent); }

        /* ç‹€æ…‹åˆ— */
        .status-bar { padding: 8px 16px; font-size: 0.8rem; color: var(--text-sub); display: flex; justify-content: space-between; }
        
        /* åˆ—è¡¨å®¹å™¨ */
        #event-list { padding: 8px 16px; max-width: 800px; margin: 0 auto; display: flex; flex-direction: column; gap: 12px; }
        
        /* æ´»å‹•å¡ç‰‡ */
        .card { background: var(--card-bg); border-radius: 12px; padding: 12px; display: flex; gap: 12px; cursor: pointer; transition: transform 0.1s; position: relative; overflow: hidden; border: 1px solid #333; }
        .card:active { transform: scale(0.98); }
        .card.read { opacity: 0.7; }
        
        .card-img { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; background: #2a2a2a; flex-shrink: 0; display: none; }
        .card-img.show { display: block; }
        
        .card-content { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; }
        
        .badges { display: flex; gap: 6px; font-size: 0.7rem; align-items: center; }
        .badge { padding: 2px 6px; border-radius: 4px; background: #333; }
        .badge.platform { color: #60a5fa; background: rgba(37,99,235,0.15); }
        .badge.new { color: #fff; background: var(--new-badge); font-weight: bold; display: none; }
        .badge.new.show { display: inline-block; }
        .badge.fav { color: #fff; background: var(--fav-badge); display: none; }
        .badge.fav.show { display: inline-block; }

        .card-title { font-size: 1rem; font-weight: 500; line-height: 1.4; margin: 0; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .card-meta { font-size: 0.8rem; color: var(--text-sub); display: flex; gap: 10px; margin-top: auto; }

        /* æ¨¡æ…‹è¦–çª— (å½ˆçª—) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; justify-content: center; align-items: end; opacity: 0; transition: opacity 0.2s; }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal { background: #1e1e1e; width: 100%; max-width: 600px; border-radius: 20px 20px 0 0; padding: 24px; display: flex; flex-direction: column; gap: 16px; max-height: 85vh; overflow-y: auto; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .modal-overlay.open .modal { transform: translateY(0); }
        
        .modal-header { display: flex; justify-content: space-between; align-items: start; }
        .close-btn { background: #333; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        
        .modal-img { width: 100%; height: 200px; object-fit: cover; border-radius: 12px; background: #2a2a2a; display: none; }
        .modal-title { font-size: 1.3rem; font-weight: bold; margin: 0; }
        .modal-info { display: grid; grid-template-columns: auto 1fr; gap: 8px 16px; font-size: 0.9rem; color: #ccc; margin-top: 8px; }
        .info-label { color: var(--text-sub); }
        
        .modal-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
        .btn { padding: 12px; border-radius: 12px; font-weight: bold; text-align: center; text-decoration: none; cursor: pointer; border: none; font-size: 1rem; }
        .btn-primary { background: var(--accent); color: #fff; }
        .btn-secondary { background: #333; color: var(--text-main); }

        /* è¨­å®šè¦–çª— */
        .settings-panel { padding: 16px; background: #222; border-radius: 12px; margin-bottom: 20px; }
        .input-group { margin-bottom: 12px; }
        .input-group label { display: block; margin-bottom: 6px; color: var(--text-sub); font-size: 0.9rem; }
        .keyword-input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #1a1a1a; color: #fff; }
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .tag { background: #333; padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; display: flex; align-items: center; gap: 6px; }
        .tag span { color: #ef4444; cursor: pointer; font-weight: bold; }

        /* è¼‰å…¥ä¸­å‹•ç•« */
        .loading { text-align: center; padding: 40px; color: var(--text-sub); }
        .hidden { display: none !important; }

        @media (min-width: 640px) {
            .modal-overlay { align-items: center; }
            .modal { border-radius: 20px; max-height: 80vh; }
        }
    </style>
</head>
<body>

<header>
    <div class="top-row">
        <h1>ğŸ“¡ æ´»å‹•æƒ…å ±é›·é”</h1>
        <div class="tools">
            <button id="img-toggle-btn" title="åˆ‡æ›åœ–ç‰‡é¡¯ç¤º">ğŸ–¼ï¸</button>
            <button id="settings-btn" title="è¨­å®šé—œéµå­—">âš™ï¸</button>
        </div>
    </div>
    <div class="filter-row">
        <input type="text" id="search-input" class="search-box" placeholder="æœå°‹æ´»å‹•...">
        <div class="chip active" data-filter="all">å…¨éƒ¨</div>
        <div class="chip" data-filter="new">ğŸ†• æ–°é€²</div>
        <div class="chip" data-filter="fav">â­ é—œæ³¨</div>
        <div class="chip" data-filter="éŸ³æ¨‚">ğŸµ éŸ³æ¨‚</div>
        <div class="chip" data-filter="å±•è¦½">ğŸ¨ å±•è¦½</div>
        <div class="chip" data-filter="è¬›åº§">ğŸ“ è¬›åº§</div>
        <div class="chip" data-filter="è¦ªå­">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ è¦ªå­</div>
    </div>
</header>

<div class="status-bar">
    <span id="update-time">æ›´æ–°æ™‚é–“: è¼‰å…¥ä¸­...</span>
    <span id="total-count">0 ç­†æ´»å‹•</span>
</div>

<div id="event-list">
    <div class="loading">æ­£åœ¨æƒæå…¨å°æ´»å‹•è³‡æ–™åº«...</div>
</div>

<div class="modal-overlay" id="detail-modal">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="badges">
                <span class="badge platform" id="m-platform">Platform</span>
                <span class="badge" id="m-type">Type</span>
            </div>
            <button class="close-btn" onclick="closeModal()">Ã—</button>
        </div>
        <img id="m-img" class="modal-img" src="" loading="lazy">
        <h2 class="modal-title" id="m-title">æ´»å‹•æ¨™é¡Œ</h2>
        
        <div class="modal-info">
            <span class="info-label">ğŸ“… æ—¥æœŸ</span> <span id="m-date">è©³è¦‹é€£çµ</span>
            <span class="info-label">ğŸ·ï¸ é¡åˆ¥</span> <span id="m-category">--</span>
            <span class="info-label">ğŸ”— ä¾†æº</span> <span id="m-source">--</span>
        </div>

        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeModal()">é—œé–‰</button>
            <a id="m-link" href="#" target="_blank" class="btn btn-primary">å‰å¾€æ´»å‹•é é¢</a>
        </div>
    </div>
</div>

<div class="modal-overlay" id="settings-modal">
    <div class="modal" onclick="event.stopPropagation()">
        <h2 class="modal-title">âš™ï¸ å€‹äººåŒ–è¨­å®š</h2>
        
        <div class="settings-panel">
            <div class="input-group">
                <label>â­ é—œæ³¨é—œéµå­— (æŒ‰ Enter æ–°å¢)</label>
                <input type="text" id="keyword-input" class="keyword-input" placeholder="ä¾‹å¦‚: äº”æœˆå¤©, å…è²», å±•è¦½">
                <div class="tags-container" id="keywords-tags"></div>
            </div>
            <p style="font-size:0.8rem; color:#888;">è¨­å®šé—œéµå­—å¾Œï¼Œç¬¦åˆçš„æ´»å‹•å°‡æ¨™ç¤ºæ˜Ÿè™Ÿä¸¦å„ªå…ˆé¡¯ç¤ºã€‚</p>
        </div>

        <div class="modal-actions">
            <button class="btn btn-primary" style="grid-column: span 2;" onclick="saveSettings()">å„²å­˜è¨­å®š</button>
        </div>
    </div>
</div>

<script>
    // === ç‹€æ…‹ç®¡ç† ===
    let allEvents = [];
    let showImages = localStorage.getItem('showImages') === 'true';
    let readEvents = JSON.parse(localStorage.getItem('readEvents') || '[]');
    let myKeywords = JSON.parse(localStorage.getItem('myKeywords') || '[]');
    
    // DOM å…ƒç´ 
    const listEl = document.getElementById('event-list');
    const searchInput = document.getElementById('search-input');
    const updateTimeEl = document.getElementById('update-time');
    const totalCountEl = document.getElementById('total-count');
    const detailModal = document.getElementById('detail-modal');
    const settingsModal = document.getElementById('settings-modal');

    // === åˆå§‹åŒ– ===
    async function init() {
        // ç¶å®šéæ¿¾å™¨
        document.querySelectorAll('.chip').forEach(chip => {
            chip.addEventListener('click', () => {
                document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                renderList();
            });
        });

        // ç¶å®šæœå°‹
        searchInput.addEventListener('input', renderList);

        // ç¶å®šæŒ‰éˆ•
        document.getElementById('img-toggle-btn').onclick = toggleImages;
        document.getElementById('settings-btn').onclick = () => {
            renderKeywords();
            settingsModal.classList.add('open');
        };

        // è¼‰å…¥è³‡æ–™ (åŠ ä¸Šæ™‚é–“æˆ³é¿å…å¿«å–)
        try {
            const res = await fetch(`data.json?t=${Date.now()}`);
            allEvents = await res.json();
            
            // æ’åºï¼šå…ˆé—œæ³¨ -> å†æ–°é€² -> å†æ™‚é–“
            allEvents.sort((a, b) => new Date(b.scraped_at) - new Date(a.scraped_at));
            
            updateTimeEl.textContent = `æ›´æ–°æ–¼: ${new Date(allEvents[0]?.scraped_at).toLocaleString()}`;
            renderList();
        } catch (e) {
            listEl.innerHTML = `<div class="loading">âŒ è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚</div>`;
            console.error(e);
        }
        
        updateImgBtnState();
    }

    // === æ ¸å¿ƒæ¸²æŸ“é‚è¼¯ ===
    function renderList() {
        const filterType = document.querySelector('.chip.active').dataset.filter;
        const searchText = searchInput.value.toLowerCase();
        
        const filtered = allEvents.filter(ev => {
            const isFav = isFavorite(ev.title);
            const isNew = !readEvents.includes(ev.url);
            
            // 1. æœå°‹æ–‡å­—éæ¿¾
            if (searchText && !ev.title.toLowerCase().includes(searchText)) return false;

            // 2. æ¨™ç±¤éæ¿¾
            if (filterType === 'all') return true;
            if (filterType === 'new') return isNew;
            if (filterType === 'fav') return isFav;
            
            // é¡åˆ¥éæ¿¾ (æ¨¡ç³Šæ¯”å°)
            return ev.type.includes(filterType);
        });

        totalCountEl.textContent = `${filtered.length} ç­†æ´»å‹•`;
        listEl.innerHTML = filtered.length ? '' : '<div class="loading">æ²’æœ‰ç¬¦åˆçš„æ´»å‹• ğŸ¢</div>';

        // è™›æ“¬åˆ—è¡¨å„ªåŒ– (åªæ¸²æŸ“å‰ 50 ç­†ï¼Œé¿å…å¡é “)
        const displayList = filtered.slice(0, 50);

        displayList.forEach(ev => {
            const isFav = isFavorite(ev.title);
            const isNew = !readEvents.includes(ev.url);
            const isRead = readEvents.includes(ev.url);
            
            const card = document.createElement('div');
            card.className = `card ${isRead ? 'read' : ''}`;
            card.onclick = () => openDetail(ev, card);

            // åœ–ç‰‡é‚è¼¯
            let imgHTML = '';
            if (showImages && ev.img_url) {
                imgHTML = `<img src="${ev.img_url}" class="card-img show" loading="lazy">`;
            }

            card.innerHTML = `
                ${imgHTML}
                <div class="card-content">
                    <div class="badges">
                        <span class="badge platform">${ev.platform}</span>
                        <span class="badge new ${isNew ? 'show' : ''}">NEW</span>
                        <span class="badge fav ${isFav ? 'show' : ''}">â­ é—œæ³¨</span>
                        <span class="badge">${ev.type}</span>
                    </div>
                    <h3 class="card-title">${ev.title}</h3>
                    <div class="card-meta">
                        <span>${ev.date !== 'è©³å…§æ–‡' ? ev.date : 'è¿‘æœŸæ´»å‹•'}</span>
                    </div>
                </div>
            `;
            listEl.appendChild(card);
        });
        
        if (filtered.length > 50) {
            const more = document.createElement('div');
            more.className = 'loading';
            more.textContent = `é‚„æœ‰ ${filtered.length - 50} ç­†æ´»å‹•ï¼Œè«‹ä½¿ç”¨æœå°‹ç¸®å°ç¯„åœ...`;
            listEl.appendChild(more);
        }
    }

    // === åŠŸèƒ½å‡½å¼ ===
    function isFavorite(title) {
        return myKeywords.some(k => title.toLowerCase().includes(k.toLowerCase()));
    }

    function toggleImages() {
        showImages = !showImages;
        localStorage.setItem('showImages', showImages);
        updateImgBtnState();
        renderList();
    }
    
    function updateImgBtnState() {
        const btn = document.getElementById('img-toggle-btn');
        btn.style.opacity = showImages ? '1' : '0.5';
        btn.title = showImages ? "éš±è—åœ–ç‰‡ (çœæµé‡)" : "é¡¯ç¤ºåœ–ç‰‡";
    }

    // === å½ˆçª—é‚è¼¯ ===
    function openDetail(ev, cardEl) {
        // æ¨™è¨˜ç‚ºå·²è®€
        if (!readEvents.includes(ev.url)) {
            readEvents.push(ev.url);
            // é™åˆ¶ç´€éŒ„æ•¸é‡é¿å… storage çˆ†æ‰
            if (readEvents.length > 1000) readEvents.shift();
            localStorage.setItem('readEvents', JSON.stringify(readEvents));
            cardEl.classList.add('read');
            cardEl.querySelector('.badge.new')?.classList.remove('show');
        }

        document.getElementById('m-platform').textContent = ev.platform;
        document.getElementById('m-type').textContent = ev.type;
        document.getElementById('m-title').textContent = ev.title;
        document.getElementById('m-date').textContent = ev.date;
        document.getElementById('m-category').textContent = ev.type;
        document.getElementById('m-source').textContent = ev.platform;
        document.getElementById('m-link').href = ev.url;
        
        const imgEl = document.getElementById('m-img');
        if (ev.img_url) {
            imgEl.src = ev.img_url;
            imgEl.style.display = 'block';
        } else {
            imgEl.style.display = 'none';
        }

        detailModal.classList.add('open');
    }

    function closeModal() {
        detailModal.classList.remove('open');
        settingsModal.classList.remove('open');
    }

    // === è¨­å®šé‚è¼¯ ===
    const keywordInput = document.getElementById('keyword-input');
    const tagsContainer = document.getElementById('keywords-tags');

    function renderKeywords() {
        tagsContainer.innerHTML = '';
        myKeywords.forEach((k, idx) => {
            const tag = document.createElement('div');
            tag.className = 'tag';
            tag.innerHTML = `${k} <span onclick="removeKeyword(${idx})">Ã—</span>`;
            tagsContainer.appendChild(tag);
        });
    }

    function addKeyword() {
        const val = keywordInput.value.trim();
        if (val && !myKeywords.includes(val)) {
            myKeywords.push(val);
            keywordInput.value = '';
            renderKeywords();
        }
    }
    
    function removeKeyword(idx) {
        myKeywords.splice(idx, 1);
        renderKeywords();
    }

    keywordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') addKeyword();
    });

    function saveSettings() {
        localStorage.setItem('myKeywords', JSON.stringify(myKeywords));
        closeModal();
        renderList(); // é‡æ–°æ¸²æŸ“ä»¥å¥—ç”¨é—œæ³¨æ¨™ç±¤
    }

    // å•Ÿå‹•
    init();
</script>

</body>
</html>
