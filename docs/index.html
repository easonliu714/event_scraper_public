<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ç£æ´»å‹•æƒ…å ±é›·é” ğŸ“¡</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #3b82f6; --chip-bg: #2a2a2a; }
        body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); padding-bottom: 60px; overscroll-behavior-y: contain; }
        
        /* ä¸‹æ‹‰æ›´æ–°æŒ‡ç¤ºå™¨ */
        #pull-to-refresh {
            position: fixed; top: -50px; left: 0; width: 100%; height: 50px;
            display: flex; justify-content: center; align-items: center;
            color: var(--accent); font-size: 1.2rem; transition: top 0.2s; z-index: 200;
        }
        #pull-to-refresh.visible { top: 60px; } /* header height */
        .spinner { animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        header { position: sticky; top: 0; z-index: 100; background: rgba(18,18,18,0.95); backdrop-filter: blur(10px); padding: 12px 16px; border-bottom: 1px solid #333; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        h1 { margin: 0; font-size: 1.2rem; }
        .search-box { width: 100%; padding: 12px; border-radius: 12px; background: #2a2a2a; border: 1px solid #333; color: #fff; font-size: 1rem; }
        
        .filter-section { padding: 16px; background: #181818; border-bottom: 1px solid #333; }
        .filter-block { margin-bottom: 16px; }
        .block-title { font-size: 0.85rem; color: #888; margin-bottom: 8px; }
        .chips { display: flex; flex-wrap: wrap; gap: 8px; }
        .chip { padding: 6px 12px; background: var(--chip-bg); border-radius: 8px; font-size: 0.9rem; cursor: pointer; border: 1px solid #333; transition: 0.2s; display: flex; gap: 6px; }
        .chip span { opacity: 0.6; font-size: 0.8em; }
        .chip.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        .chip.active span { opacity: 1; color: #fff; }
        .chip[data-type="status"].active { background: #10b981; border-color: #10b981; }
        
        .list-header { padding: 12px 16px; font-size: 0.9rem; color: #aaa; background: #121212; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        
        #event-list { max-width: 800px; margin: 0 auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; min-height: 300px; }
        .card { background: var(--card); border-radius: 12px; padding: 12px; display: flex; gap: 12px; border: 1px solid #333; }
        .card.read { opacity: 0.6; }
        .card-img { width: 90px; height: 90px; border-radius: 8px; background: #333; object-fit: cover; }
        .card-info { flex: 1; display: flex; flex-direction: column; gap: 4px; }
        .badges { display: flex; flex-wrap: wrap; gap: 4px; font-size: 0.75rem; }
        .badge { padding: 2px 6px; border-radius: 4px; background: #333; color: #ccc; }
        .badge.new { background: #ef4444; color: #fff; }
        .badge.fav { background: #f59e0b; color: #fff; }
        
        .pagination { display: flex; justify-content: center; align-items: center; gap: 16px; margin: 20px 0; }
        .page-btn { padding: 8px 16px; background: #333; border: none; color: #fff; border-radius: 8px; cursor: pointer; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 200; display: none; justify-content: center; align-items: end; }
        .modal-overlay.open { display: flex; }
        .modal { background: #222; width: 100%; max-width: 600px; padding: 24px; border-radius: 20px 20px 0 0; max-height: 90vh; overflow-y: auto; }
        
        .settings-panel { padding: 16px; background: #2a2a2a; border-radius: 12px; margin-bottom: 16px; }
        .keyword-input { width: 100%; padding: 10px; border-radius: 8px; background: #121212; border: 1px solid #444; color: #fff; margin-bottom: 8px; }
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag { background: #444; padding: 4px 10px; border-radius: 16px; font-size: 0.85rem; display: flex; gap: 6px; }
    </style>
</head>
<body>

<div id="pull-to-refresh">
    <span id="ptr-icon">â¬‡ï¸ ä¸‹æ‹‰æ›´æ–°</span>
    <span id="ptr-spinner" class="spinner">ğŸ”„</span>
</div>

<header>
    <div class="top-bar">
        <h1>ğŸ“¡ æ´»å‹•é›·é”</h1>
        <button onclick="openSettings()" style="background:none; border:none; font-size:1.5rem;">âš™ï¸</button>
    </div>
    <input type="text" id="search" class="search-box" placeholder="æœå°‹é—œéµå­—..." oninput="resetPageAndRender()">
</header>

<div class="filter-section">
    <div class="filter-block">
        <div class="block-title">ğŸ›ï¸ å¹³å°ç¯©é¸ (è¯é›† OR)</div>
        <div id="platform-chips" class="chips"></div>
    </div>
    <div class="filter-block">
        <div class="block-title">âœ¨ ç‹€æ…‹ç¯©é¸ (äº¤é›† AND)</div>
        <div class="chips" id="status-chips"></div>
    </div>
    <div class="filter-block">
        <div class="block-title">ğŸ·ï¸ é¡åˆ¥ç¯©é¸ (è¯é›† OR)</div>
        <div id="type-chips" class="chips"></div>
    </div>
</div>

<div class="list-header">
    <span id="result-count">é¡¯ç¤º 0 ç­†æ´»å‹•</span>
    <span id="update-time" style="font-size:0.8em">æ›´æ–°æ–¼: ...</span>
</div>

<div id="event-list"></div>

<div class="pagination">
    <button class="page-btn" onclick="changePage(-1)" id="prev-btn">â—€ ä¸Šä¸€é </button>
    <span id="page-info">ç¬¬ 1 / 1 é </span>
    <button class="page-btn" onclick="changePage(1)" id="next-btn">ä¸‹ä¸€é  â–¶</button>
</div>

<div class="modal-overlay" id="detail-modal" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <img id="m-img" style="width:100%; max-height:250px; object-fit:cover; border-radius:12px; margin-bottom:16px; display:none;">
        <h2 id="m-title" style="margin-bottom:10px;"></h2>
        <p id="m-platform" style="color:#60a5fa; margin-bottom:5px;"></p>
        <p id="m-category" style="color:#ccc; font-size:0.9rem; margin-bottom:15px;"></p>
        <a id="m-link" href="#" target="_blank" style="display:block; padding:12px; background:#3b82f6; color:#fff; text-align:center; border-radius:8px; text-decoration:none;">å‰å¾€å®˜ç¶²</a>
    </div>
</div>

<div class="modal-overlay" id="settings-modal" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <h2>âš™ï¸ è¨­å®š</h2>
        <div class="settings-panel">
            <label>â­ é—œæ³¨é—œéµå­— (æŒ‰ Enter æ–°å¢)</label>
            <input type="text" id="keyword-input" class="keyword-input">
            <div id="keywords-tags" class="tags-container"></div>
        </div>
        <div class="settings-panel">
            <button onclick="requestNotifyPermission()" style="width:100%; padding:10px; background:#333; color:#fff; border:none; border-radius:8px;">ğŸ”” æª¢æŸ¥é€šçŸ¥æ¬Šé™</button>
        </div>
    </div>
</div>

<script>
    let allEvents = [];
    let filteredEvents = [];
    let currentPage = 1;
    const PAGE_SIZE = 50;
    
    const filters = { platforms: new Set(), status: new Set(), types: new Set() };
    let myKeywords = JSON.parse(localStorage.getItem('myKeywords') || '[]');
    let readEvents = JSON.parse(localStorage.getItem('readEvents') || '[]');

    // ä¸‹æ‹‰æ›´æ–°é‚è¼¯
    let touchStartY = 0;
    const ptrEl = document.getElementById('pull-to-refresh');
    const ptrIcon = document.getElementById('ptr-icon');
    const ptrSpinner = document.getElementById('ptr-spinner');

    window.addEventListener('touchstart', e => {
        if (window.scrollY === 0) touchStartY = e.touches[0].clientY;
    });

    window.addEventListener('touchmove', e => {
        const touchY = e.touches[0].clientY;
        if (window.scrollY === 0 && touchY > touchStartY) {
            const pullDistance = touchY - touchStartY;
            if (pullDistance > 60) {
                ptrEl.style.top = '60px'; // é¡¯ç¤ºä¸‹æ‹‰åœ–ç¤º
                ptrIcon.style.display = 'block';
                ptrSpinner.style.display = 'none';
            }
        }
    });

    window.addEventListener('touchend', async e => {
        if (ptrEl.style.top === '60px') {
            ptrIcon.style.display = 'none';
            ptrSpinner.style.display = 'block'; // è½‰åœˆåœˆ
            await init(); // é‡æ–°è®€å–è³‡æ–™
            setTimeout(() => {
                ptrEl.style.top = '-50px'; // éš±è—
            }, 500);
        }
    });

    async function init() {
        try {
            const res = await fetch(`data.json?t=${Date.now()}`); // å¼·åˆ¶ä¸å¿«å–
            allEvents = await res.json();
            allEvents.sort((a,b) => new Date(b.scraped_at) - new Date(a.scraped_at));
            
            document.getElementById('update-time').textContent = `æ›´æ–°æ–¼: ${new Date(allEvents[0]?.scraped_at).toLocaleString()}`;
            renderChips();
            applyFilters();
        } catch(e) {
            console.error(e);
            document.getElementById('event-list').innerHTML = '<div style="text-align:center; padding:40px;">âŒ è³‡æ–™è¼‰å…¥å¤±æ•—</div>';
        }
    }

    function renderChips() {
        const pStats = {}; allEvents.forEach(e => pStats[e.platform] = (pStats[e.platform]||0)+1);
        document.getElementById('platform-chips').innerHTML = Object.entries(pStats).sort((a,b) => b[1]-a[1]).map(([k,v]) => `<div class="chip" onclick="toggleFilter('platforms', '${k}', this)">${k} <span>${v}</span></div>`).join('');

        const tStats = {}; allEvents.forEach(e => tStats[e.type] = (tStats[e.type]||0)+1);
        document.getElementById('type-chips').innerHTML = Object.entries(tStats).sort((a,b) => b[1]-a[1]).map(([k,v]) => `<div class="chip" onclick="toggleFilter('types', '${k}', this)">${k} <span>${v}</span></div>`).join('');

        updateStatusCounts();
    }

    function updateStatusCounts() {
        const newCount = allEvents.filter(e => !readEvents.includes(e.url)).length;
        const favCount = allEvents.filter(e => myKeywords.some(k => e.title.includes(k))).length;
        const isNewActive = filters.status.has('isNew') ? 'active' : '';
        const isFavActive = filters.status.has('isFav') ? 'active' : '';
        document.getElementById('status-chips').innerHTML = `
            <div class="chip ${isNewActive}" data-type="status" onclick="toggleFilter('status', 'isNew', this)">ğŸ†• æ–°é€²æ´»å‹• <span>${newCount}</span></div>
            <div class="chip ${isFavActive}" data-type="status" onclick="toggleFilter('status', 'isFav', this)">â­ é—œæ³¨é—œéµå­— <span>${favCount}</span></div>
        `;
    }

    function toggleFilter(category, value, el) {
        el.classList.toggle('active');
        if (filters[category].has(value)) filters[category].delete(value);
        else filters[category].add(value);
        resetPageAndRender();
    }

    function resetPageAndRender() { currentPage = 1; applyFilters(); }

    function applyFilters() {
        const query = document.getElementById('search').value.toLowerCase();
        filteredEvents = allEvents.filter(e => {
            const isFav = myKeywords.some(k => e.title.includes(k));
            const isNew = !readEvents.includes(e.url);
            if (query && !e.title.toLowerCase().includes(query)) return false;
            if (filters.platforms.size > 0 && !filters.platforms.has(e.platform)) return false;
            if (filters.types.size > 0 && !filters.types.has(e.type)) return false;
            if (filters.status.has('isNew') && !isNew) return false;
            if (filters.status.has('isFav') && !isFav) return false;
            return true;
        });
        document.getElementById('result-count').textContent = `é¡¯ç¤º ${filteredEvents.length} ç­†æ´»å‹• (å…± ${allEvents.length} ç­†)`;
        renderList();
        renderPagination();
    }

    function renderList() {
        const start = (currentPage - 1) * PAGE_SIZE;
        const pageData = filteredEvents.slice(start, start + PAGE_SIZE);
        const list = document.getElementById('event-list');
        if(pageData.length === 0) { list.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ´»å‹• ğŸ¢</div>'; return; }
        list.innerHTML = pageData.map(e => {
            const isFav = myKeywords.some(k => e.title.includes(k));
            const isNew = !readEvents.includes(e.url);
            return `<div class="card ${!isNew ? 'read' : ''}" onclick="openDetail('${e.url}')">
                    ${e.img_url ? `<img src="${e.img_url}" class="card-img" loading="lazy">` : ''}
                    <div class="card-info">
                        <div class="badges"><span class="badge" style="color:#60a5fa">${e.platform}</span>${isNew ? '<span class="badge new">NEW</span>' : ''}${isFav ? '<span class="badge fav">â­ é—œæ³¨</span>' : ''}<span class="badge">${e.type}</span></div>
                        <div style="font-weight:500; font-size:1rem;">${e.title}</div>
                        <div style="font-size:0.8rem; color:#888;">${e.date}</div>
                    </div></div>`;
        }).join('');
    }

    function renderPagination() {
        const totalPages = Math.ceil(filteredEvents.length / PAGE_SIZE) || 1;
        document.getElementById('page-info').textContent = `ç¬¬ ${currentPage} / ${totalPages} é `;
        document.getElementById('prev-btn').disabled = currentPage === 1;
        document.getElementById('next-btn').disabled = currentPage === totalPages;
    }

    function changePage(delta) { currentPage += delta; renderList(); renderPagination(); window.scrollTo(0, 0); }

    function openDetail(url) {
        const ev = allEvents.find(e => e.url === url);
        if(!ev) return;
        if(!readEvents.includes(url)) { readEvents.push(url); localStorage.setItem('readEvents', JSON.stringify(readEvents)); updateStatusCounts(); }
        document.getElementById('m-title').textContent = ev.title;
        document.getElementById('m-platform').textContent = ev.platform;
        document.getElementById('m-category').textContent = ev.type;
        document.getElementById('m-link').href = ev.url;
        const img = document.getElementById('m-img');
        if(ev.img_url) { img.src = ev.img_url; img.style.display = 'block'; } else { img.style.display = 'none'; }
        document.getElementById('detail-modal').classList.add('open');
        renderList();
    }

    function closeModal() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('open')); }
    function openSettings() { renderKeywords(); document.getElementById('settings-modal').classList.add('open'); }
    function renderKeywords() { document.getElementById('keywords-tags').innerHTML = myKeywords.map((k, i) => `<div class="tag">${k} <span onclick="removeKeyword(${i})" style="cursor:pointer; color:#f87171">Ã—</span></div>`).join(''); }
    function removeKeyword(i) { myKeywords.splice(i, 1); renderKeywords(); localStorage.setItem('myKeywords', JSON.stringify(myKeywords)); applyFilters(); updateStatusCounts(); }
    document.getElementById('keyword-input').onkeypress = (e) => { if(e.key === 'Enter') { const val = e.target.value.trim(); if(val && !myKeywords.includes(val)) { myKeywords.push(val); e.target.value = ''; renderKeywords(); localStorage.setItem('myKeywords', JSON.stringify(myKeywords)); applyFilters(); updateStatusCounts(); } } };
    function requestNotifyPermission() { Notification.requestPermission().then(p => alert(p === "granted" ? "âœ… é€šçŸ¥å·²é–‹å•Ÿ" : "ğŸš« é€šçŸ¥è¢«æ‹’çµ•")); }

    init();
</script>
</body>
</html>
