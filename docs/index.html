<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ç£æ´»å‹•æƒ…å ±é›·é” ğŸ“¡</title>
    <meta name="description" content="è‡ªå‹•å½™æ•´å…¨å°å„å¤§å”®ç¥¨ç¶²èˆ‡æ´»å‹•å¹³å°çš„æœ€æ–°æƒ…å ±">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1a1a">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“¡</text></svg>">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">

    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sub: #a0a0a0;
            --accent: #3b82f6;
            --new-badge: #ef4444;
            --fav-badge: #f59e0b;
            --chip-bg: #2a2a2a;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-color); color: var(--text-main); padding-bottom: 40px; }
        
        /* é ‚éƒ¨å°èˆª */
        header { position: sticky; top: 0; background: rgba(18,18,18,0.95); backdrop-filter: blur(10px); z-index: 100; padding: 12px 16px; border-bottom: 1px solid #333; }
        .top-row { display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; }
        .search-box { width: 100%; margin-top: 12px; background: #2a2a2a; border: none; padding: 10px 16px; border-radius: 20px; color: #fff; font-size: 1rem; outline: none; border: 1px solid #333; }
        .tools button { background: none; border: none; color: var(--text-main); font-size: 1.2rem; cursor: pointer; padding: 4px; }

        /* çµ±è¨ˆèˆ‡éæ¿¾å€ (å¤šé¸é¢æ¿) */
        .filter-section { padding: 12px 16px; background: #1a1a1a; border-bottom: 1px solid #333; }
        .filter-group { margin-bottom: 14px; }
        .filter-label { font-size: 0.8rem; color: var(--text-sub); margin-bottom: 8px; display: block; letter-spacing: 1px; }
        
        .chips-wrapper { display: flex; flex-wrap: wrap; gap: 8px; }
        .chip { padding: 6px 12px; border-radius: 10px; background: var(--chip-bg); font-size: 0.85rem; border: 1px solid #333; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px; }
        .chip span { opacity: 0.5; font-size: 0.75rem; }
        
        /* å¤šé¸å•Ÿå‹•æ¨£å¼ */
        .chip.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        .chip.active span { opacity: 1; }
        .chip.fav-chip.active { background: var(--fav-badge); border-color: var(--fav-badge); }
        .chip.new-chip.active { background: var(--new-badge); border-color: var(--new-badge); }

        /* ç‹€æ…‹åˆ— */
        .status-bar { padding: 8px 16px; font-size: 0.75rem; color: var(--text-sub); display: flex; justify-content: space-between; background: var(--bg-color); }
        
        /* åˆ—è¡¨å®¹å™¨ */
        #event-list { padding: 8px 16px; max-width: 800px; margin: 0 auto; display: flex; flex-direction: column; gap: 12px; }
        
        /* æ´»å‹•å¡ç‰‡ */
        .card { background: var(--card-bg); border-radius: 16px; padding: 12px; display: flex; gap: 12px; cursor: pointer; border: 1px solid #333; transition: transform 0.1s; position: relative; }
        .card:active { transform: scale(0.98); }
        .card.read { opacity: 0.6; }
        
        .card-img { width: 85px; height: 85px; border-radius: 10px; object-fit: cover; background: #2a2a2a; flex-shrink: 0; }
        .card-content { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 6px; }
        
        .badge-row { display: flex; flex-wrap: wrap; gap: 6px; }
        .badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #333; color: #bbb; }
        .badge.platform { color: #60a5fa; background: rgba(59, 130, 246, 0.15); }
        .badge.new { background: var(--new-badge); color: #fff; }
        .badge.fav { background: var(--fav-badge); color: #fff; }

        .card-title { font-size: 1.05rem; font-weight: 500; line-height: 1.4; margin: 0; color: #fff; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .card-meta { font-size: 0.8rem; color: var(--text-sub); }

        /* æ¨¡æ…‹è¦–çª— (å½ˆçª—) */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; display: none; justify-content: center; align-items: end; opacity: 0; transition: opacity 0.2s; }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal { background: #1e1e1e; width: 100%; max-width: 600px; border-radius: 24px 24px 0 0; padding: 24px; max-height: 90vh; overflow-y: auto; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .modal-overlay.open .modal { transform: translateY(0); }
        
        .modal-img { width: 100%; height: auto; max-height: 250px; object-fit: cover; border-radius: 16px; margin-bottom: 16px; background: #333; }
        .modal-title { font-size: 1.3rem; margin: 0 0 12px 0; line-height: 1.4; }
        .modal-info { display: grid; grid-template-columns: auto 1fr; gap: 10px 16px; font-size: 0.95rem; color: #ccc; border-top: 1px solid #333; padding-top: 16px; }
        .info-label { color: var(--text-sub); }
        
        .modal-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 24px; }
        .btn { padding: 14px; border-radius: 14px; font-weight: bold; border: none; cursor: pointer; font-size: 1rem; text-align: center; text-decoration: none; }
        .btn-primary { background: var(--accent); color: #fff; }
        .btn-secondary { background: #333; color: #fff; }
        
        /* è¨­å®šé¢æ¿æ¨£å¼ */
        .settings-panel { background: #262626; padding: 16px; border-radius: 16px; margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-sub); }
        .keyword-input { width: 100%; padding: 12px; border-radius: 10px; background: #121212; border: 1px solid #444; color: #fff; margin-bottom: 12px; }
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag { background: #404040; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; }
        .tag span { color: #ff5f5f; font-weight: bold; cursor: pointer; }

        .loading { text-align: center; padding: 50px; color: var(--text-sub); font-size: 0.9rem; }
    </style>
</head>
<body>

<header>
    <div class="top-row">
        <h1>ğŸ“¡ æ´»å‹•æƒ…å ±é›·é”</h1>
        <div class="tools">
            <button id="img-toggle-btn">ğŸ–¼ï¸</button>
            <button id="settings-btn">âš™ï¸</button>
        </div>
    </div>
    <input type="text" id="search-input" class="search-box" placeholder="æœå°‹é—œéµå­—æˆ–æ´»å‹•...">
</header>

<div class="filter-section">
    <div class="filter-group">
        <span class="filter-label">ğŸ›ï¸ å¹³å°çµ±è¨ˆ (å¤šé¸)</span>
        <div id="platform-chips" class="chips-wrapper"></div>
    </div>
    
    <div class="filter-group">
        <span class="filter-label">ğŸ·ï¸ é¡åˆ¥èˆ‡ç‹€æ…‹ (å¤šé¸)</span>
        <div id="type-chips" class="chips-wrapper">
            <div class="chip new-chip" data-val="isNew">ğŸ†• æ–°é€²</div>
            <div class="chip fav-chip" data-val="isFav">â­ é—œæ³¨</div>
            </div>
    </div>
</div>

<div class="status-bar">
    <span id="update-time">æ›´æ–°æ™‚é–“: è¼‰å…¥ä¸­...</span>
    <span id="total-count">0 ç­†æ´»å‹•</span>
</div>

<div id="event-list">
    <div class="loading">æ­£åœ¨åŒæ­¥æœ€æ–°å…¨å°æ´»å‹•è³‡æ–™...</div>
</div>

<div class="modal-overlay" id="detail-modal" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <img id="m-img" class="modal-img" src="">
        <h2 id="m-title" class="modal-title"></h2>
        <div class="modal-info">
            <span class="info-label">ğŸ›ï¸ å¹³å°</span> <span id="m-platform"></span>
            <span class="info-label">ğŸ·ï¸ é¡åˆ¥</span> <span id="m-category"></span>
            <span class="info-label">ğŸ“… æ—¥æœŸ</span> <span id="m-date">è©³å…§æ–‡</span>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeModal()">é—œé–‰</button>
            <a id="m-link" href="#" target="_blank" class="btn btn-primary">å‰å¾€å®˜ç¶²è³¼ç¥¨</a>
        </div>
    </div>
</div>

<div class="modal-overlay" id="settings-modal" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <h2 class="modal-title">âš™ï¸ å€‹äººåŒ–è¨­å®š</h2>
        <div class="settings-panel">
            <div class="input-group">
                <label>â­ é—œæ³¨é—œéµå­— (æŒ‰ Enter æ–°å¢)</label>
                <input type="text" id="keyword-input" class="keyword-input" placeholder="ä¾‹å¦‚: äº”æœˆå¤©, å…è²», å±•è¦½">
                <div class="tags-container" id="keywords-tags"></div>
            </div>
        </div>
        <div class="settings-panel">
            <div class="input-group">
                <label>ğŸ”” æœ¬æ©Ÿé€šçŸ¥æ¬Šé™</label>
                <button id="notify-perm-btn" class="btn btn-secondary" style="width:100%" onclick="requestNotifyPermission()">é»æ“Šæª¢æŸ¥é€šçŸ¥æ¬Šé™</button>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-primary" style="grid-column: span 2;" onclick="saveSettings()">å„²å­˜ä¸¦é—œé–‰</button>
        </div>
    </div>
</div>

<script>
    // === ç‹€æ…‹è®Šæ•¸ ===
    let allEvents = [];
    let activePlatforms = new Set();
    let activeTypes = new Set();
    let showImages = localStorage.getItem('showImages') !== 'false'; // é è¨­é–‹å•Ÿ
    let myKeywords = JSON.parse(localStorage.getItem('myKeywords') || '[]');
    let readEvents = JSON.parse(localStorage.getItem('readEvents') || '[]');
    let lastCheckTime = localStorage.getItem('lastCheckTime') || new Date().toISOString();

    const listEl = document.getElementById('event-list');
    const searchInput = document.getElementById('search-input');
    const platformContainer = document.getElementById('platform-chips');
    const typeContainer = document.getElementById('type-chips');

    // === åˆå§‹åŒ– ===
    async function init() {
        try {
            const res = await fetch(`data.json?t=${Date.now()}`);
            allEvents = await res.json();
            
            // æ’åº
            allEvents.sort((a, b) => new Date(b.scraped_at) - new Date(a.scraped_at));
            
            document.getElementById('update-time').textContent = `æ›´æ–°æ™‚é–“: ${new Date(allEvents[0]?.scraped_at).toLocaleString()}`;
            
            renderPlatformChips();
            renderTypeChips();
            checkNewEventsForNotify();
            renderList();
        } catch (e) {
            listEl.innerHTML = '<div class="loading">âŒ è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª data.json æ ¼å¼ã€‚</div>';
        }

        searchInput.oninput = renderList;
        document.getElementById('img-toggle-btn').onclick = toggleImages;
        document.getElementById('settings-btn').onclick = openSettings;
        updateImgBtnState();
    }

    // === éæ¿¾å™¨æ¸²æŸ“ (å¤šé¸é‚è¼¯) ===
    function renderPlatformChips() {
        const stats = {};
        allEvents.forEach(e => stats[e.platform] = (stats[e.platform] || 0) + 1);
        
        platformContainer.innerHTML = Object.entries(stats).sort((a,b) => b[1]-a[1]).map(([name, count]) => `
            <div class="chip platform-chip" data-val="${name}">${name} <span>${count}</span></div>
        `).join('');

        platformContainer.querySelectorAll('.chip').forEach(c => {
            c.onclick = () => {
                c.classList.toggle('active');
                if(c.classList.contains('active')) activePlatforms.add(c.dataset.val);
                else activePlatforms.delete(c.dataset.val);
                renderList();
            };
        });
    }

    function renderTypeChips() {
        const types = new Set();
        allEvents.forEach(e => types.add(e.type));
        
        const staticChips = Array.from(typeContainer.querySelectorAll('.chip'));
        typeContainer.innerHTML = '';
        staticChips.forEach(c => typeContainer.appendChild(c));

        Array.from(types).forEach(t => {
            const chip = document.createElement('div');
            chip.className = 'chip';
            chip.dataset.val = t;
            chip.textContent = t;
            typeContainer.appendChild(chip);
        });

        typeContainer.querySelectorAll('.chip').forEach(c => {
            c.onclick = () => {
                c.classList.toggle('active');
                if(c.classList.contains('active')) activeTypes.add(c.dataset.val);
                else activeTypes.delete(c.dataset.val);
                renderList();
            };
        });
    }

    // === æ ¸å¿ƒæ¸²æŸ“ ===
    function renderList() {
        const query = searchInput.value.toLowerCase();
        
        const filtered = allEvents.filter(e => {
            const isFav = myKeywords.some(k => e.title.includes(k));
            const isNew = !readEvents.includes(e.url);
            
            if (query && !e.title.toLowerCase().includes(query)) return false;
            if (activePlatforms.size > 0 && !activePlatforms.has(e.platform)) return false;
            
            if (activeTypes.size > 0) {
                const matchNew = activeTypes.has('isNew') && isNew;
                const matchFav = activeTypes.has('isFav') && isFav;
                const matchT = activeTypes.has(e.type);
                if (!matchNew && !matchFav && !matchT) return false;
            }
            return true;
        });

        document.getElementById('total-count').textContent = `${filtered.length} ç­†æ´»å‹•`;
        
        listEl.innerHTML = filtered.slice(0, 100).map(e => {
            const isFav = myKeywords.some(k => e.title.includes(k));
            const isNew = !readEvents.includes(e.url);
            const imgHTML = (showImages && e.img_url) ? `<img src="${e.img_url}" class="card-img" onerror="this.style.display='none'">` : '';
            
            return `
                <div class="card ${!isNew ? 'read' : ''}" onclick="openDetail('${e.url}')">
                    ${imgHTML}
                    <div class="card-content">
                        <div class="badge-row">
                            <span class="badge platform">${e.platform}</span>
                            <span class="badge">${e.type}</span>
                            ${isNew ? '<span class="badge new">NEW</span>' : ''}
                            ${isFav ? '<span class="badge fav">â­ é—œæ³¨</span>' : ''}
                        </div>
                        <h3 class="card-title">${e.title}</h3>
                        <div class="card-meta">${e.date}</div>
                    </div>
                </div>
            `;
        }).join('');
        
        if (filtered.length > 100) {
            const more = document.createElement('div');
            more.className = 'loading';
            more.textContent = `--- åƒ…é¡¯ç¤ºå‰ 100 ç­†ï¼Œè«‹ç¸®å°ç¯©é¸ç¯„åœ ---`;
            listEl.appendChild(more);
        }
    }

    // === åŠŸèƒ½é‚è¼¯ ===
    function openDetail(url) {
        const ev = allEvents.find(e => e.url === url);
        if(!ev) return;
        if(!readEvents.includes(url)) {
            readEvents.push(url);
            localStorage.setItem('readEvents', JSON.stringify(readEvents));
        }
        document.getElementById('m-title').textContent = ev.title;
        document.getElementById('m-platform').textContent = ev.platform;
        document.getElementById('m-category').textContent = ev.type;
        document.getElementById('m-date').textContent = ev.date;
        document.getElementById('m-link').href = ev.url;
        document.getElementById('m-img').src = ev.img_url || '';
        document.getElementById('m-img').style.display = ev.img_url ? 'block' : 'none';
        document.getElementById('detail-modal').classList.add('open');
        renderList();
    }

    function closeModal() {
        document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('open'));
    }

    function toggleImages() {
        showImages = !showImages;
        localStorage.setItem('showImages', showImages);
        updateImgBtnState();
        renderList();
    }

    function updateImgBtnState() {
        document.getElementById('img-toggle-btn').style.opacity = showImages ? '1' : '0.4';
    }

    // === è¨­å®šèˆ‡é€šçŸ¥ ===
    function openSettings() {
        renderKeywords();
        document.getElementById('settings-modal').classList.add('open');
    }

    function renderKeywords() {
        const container = document.getElementById('keywords-tags');
        container.innerHTML = myKeywords.map((k, i) => `
            <div class="tag">${k} <span onclick="removeKeyword(${i})">Ã—</span></div>
        `).join('');
    }

    document.getElementById('keyword-input').onkeypress = (e) => {
        if(e.key === 'Enter') {
            const val = e.target.value.trim();
            if(val && !myKeywords.includes(val)) {
                myKeywords.push(val);
                e.target.value = '';
                renderKeywords();
            }
        }
    };

    function removeKeyword(i) {
        myKeywords.splice(i, 1);
        renderKeywords();
    }

    function saveSettings() {
        localStorage.setItem('myKeywords', JSON.stringify(myKeywords));
        closeModal();
        renderList();
    }

    function requestNotifyPermission() {
        if (!("Notification" in window)) return;
        Notification.requestPermission().then(permission => {
            const btn = document.getElementById('notify-perm-btn');
            if (permission === "granted") btn.textContent = "âœ… å·²é–‹å•Ÿé€šçŸ¥";
            else btn.textContent = "ğŸš« é€šçŸ¥å·²è¢«æ‹’çµ•";
        });
    }

    function checkNewEventsForNotify() {
        if (Notification.permission !== "granted") return;
        const newMatches = allEvents.filter(e => new Date(e.scraped_at) > new Date(lastCheckTime) && myKeywords.some(k => e.title.includes(k)));
        if (newMatches.length > 0) {
            new Notification("æ´»å‹•é›·é”ç™¼ç¾é—œæ³¨æ´»å‹•ï¼", {
                body: `ç™¼ç¾ ${newMatches.length} ç­†ç¬¦åˆé—œéµå­—çš„æ–°æ´»å‹•`,
                icon: "https://raw.githubusercontent.com/twitter/twemoji/master/assets/72x72/1f4e1.png"
            });
        }
        if (allEvents.length > 0) localStorage.setItem('lastCheckTime', allEvents[0].scraped_at);
    }

    init();
</script>
</body>
</html>
