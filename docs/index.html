<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ç£æ´»å‹•æƒ…å ±é›·é” ğŸ“¡</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #3b82f6; --chip-bg: #2a2a2a; }
        body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); padding-bottom: 60px; }
        
        /* ä½ˆå±€å„ªåŒ– */
        header { position: sticky; top: 0; z-index: 100; background: rgba(18,18,18,0.95); backdrop-filter: blur(10px); padding: 12px 16px; border-bottom: 1px solid #333; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        h1 { margin: 0; font-size: 1.2rem; }
        .search-box { width: 100%; padding: 12px; border-radius: 12px; background: #2a2a2a; border: 1px solid #333; color: #fff; font-size: 1rem; }
        
        /* éæ¿¾å€å¡Š - ä¸‰æ®µå¼ */
        .filter-section { padding: 16px; background: #181818; border-bottom: 1px solid #333; }
        .filter-block { margin-bottom: 16px; }
        .block-title { font-size: 0.85rem; color: #888; margin-bottom: 8px; display: flex; justify-content: space-between; }
        .chips { display: flex; flex-wrap: wrap; gap: 8px; }
        .chip { padding: 6px 12px; background: var(--chip-bg); border-radius: 8px; font-size: 0.9rem; cursor: pointer; border: 1px solid #333; transition: 0.2s; display: flex; gap: 6px; }
        .chip span { opacity: 0.6; font-size: 0.8em; }
        .chip.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        .chip.active span { opacity: 1; color: #fff; }
        
        /* ç‰¹åˆ¥æ¨£å¼ */
        .chip[data-type="status"].active { background: #10b981; border-color: #10b981; } /* ç‹€æ…‹ç”¨ç¶ è‰² */
        
        /* åˆ—è¡¨ */
        #event-list { max-width: 800px; margin: 0 auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        .card { background: var(--card); border-radius: 12px; padding: 12px; display: flex; gap: 12px; border: 1px solid #333; }
        .card-img { width: 90px; height: 90px; border-radius: 8px; background: #333; object-fit: cover; }
        .card-info { flex: 1; display: flex; flex-direction: column; gap: 4px; }
        .badges { display: flex; flex-wrap: wrap; gap: 4px; font-size: 0.75rem; }
        .badge { padding: 2px 6px; border-radius: 4px; background: #333; color: #ccc; }
        .badge.new { background: #ef4444; color: #fff; }
        .badge.fav { background: #f59e0b; color: #fff; }
        
        /* åˆ†é æ§åˆ¶ */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 16px; margin: 20px 0; }
        .page-btn { padding: 8px 16px; background: #333; border: none; color: #fff; border-radius: 8px; cursor: pointer; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Modal (ä¿æŒä¸è®Šï¼Œç•¥) */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 200; display: none; justify-content: center; align-items: end; }
        .modal-overlay.open { display: flex; }
        .modal { background: #222; width: 100%; max-width: 600px; padding: 24px; border-radius: 20px 20px 0 0; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body>

<header>
    <div class="top-bar">
        <h1>ğŸ“¡ æ´»å‹•é›·é”</h1>
        <button onclick="openSettings()" style="background:none; border:none; font-size:1.5rem;">âš™ï¸</button>
    </div>
    <input type="text" id="search" class="search-box" placeholder="æœå°‹é—œéµå­—..." oninput="resetPageAndRender()">
</header>

<div class="filter-section">
    <div class="filter-block">
        <div class="block-title">ğŸ›ï¸ å¹³å°ç¯©é¸ (è¯é›† OR)</div>
        <div id="platform-chips" class="chips"></div>
    </div>
    
    <div class="filter-block">
        <div class="block-title">âœ¨ ç‹€æ…‹ç¯©é¸ (äº¤é›† AND)</div>
        <div class="chips">
            <div class="chip" data-type="status" data-val="isNew" onclick="toggleFilter('status', 'isNew')">ğŸ†• æ–°é€²æ´»å‹•</div>
            <div class="chip" data-type="status" data-val="isFav" onclick="toggleFilter('status', 'isFav')">â­ é—œæ³¨é—œéµå­—</div>
        </div>
    </div>

    <div class="filter-block">
        <div class="block-title">ğŸ·ï¸ é¡åˆ¥ç¯©é¸ (è¯é›† OR)</div>
        <div id="type-chips" class="chips"></div>
    </div>
</div>

<div id="event-list"></div>

<div class="pagination">
    <button class="page-btn" onclick="changePage(-1)" id="prev-btn">â—€ ä¸Šä¸€é </button>
    <span id="page-info">ç¬¬ 1 / 1 é </span>
    <button class="page-btn" onclick="changePage(1)" id="next-btn">ä¸‹ä¸€é  â–¶</button>
</div>

<script>
    let allEvents = [];
    let filteredEvents = [];
    let currentPage = 1;
    const PAGE_SIZE = 50;
    
    // ç‹€æ…‹
    const filters = {
        platforms: new Set(), // OR
        status: new Set(),    // AND
        types: new Set()      // OR
    };

    let myKeywords = JSON.parse(localStorage.getItem('myKeywords') || '[]');
    let readEvents = JSON.parse(localStorage.getItem('readEvents') || '[]');

    async function init() {
        const res = await fetch(`data.json?t=${Date.now()}`);
        allEvents = await res.json();
        // æ’åº
        allEvents.sort((a,b) => new Date(b.scraped_at) - new Date(a.scraped_at));
        
        renderChips();
        applyFilters(); // åˆå§‹æ¸²æŸ“
    }

    function renderChips() {
        // Render Platforms
        const pStats = {};
        allEvents.forEach(e => pStats[e.platform] = (pStats[e.platform]||0)+1);
        document.getElementById('platform-chips').innerHTML = Object.entries(pStats)
            .sort((a,b) => b[1]-a[1])
            .map(([k,v]) => `<div class="chip" onclick="toggleFilter('platforms', '${k}', this)">${k} <span>${v}</span></div>`)
            .join('');

        // Render Types
        const tStats = {};
        allEvents.forEach(e => tStats[e.type] = (tStats[e.type]||0)+1);
        document.getElementById('type-chips').innerHTML = Object.entries(tStats)
            .sort((a,b) => b[1]-a[1])
            .map(([k,v]) => `<div class="chip" onclick="toggleFilter('types', '${k}', this)">${k} <span>${v}</span></div>`)
            .join('');
    }

    function toggleFilter(category, value, el) {
        if (el) el.classList.toggle('active');
        else document.querySelector(`.chip[data-val="${value}"]`).classList.toggle('active');

        if (filters[category].has(value)) filters[category].delete(value);
        else filters[category].add(value);
        
        resetPageAndRender();
    }

    function resetPageAndRender() {
        currentPage = 1;
        applyFilters();
    }

    function applyFilters() {
        const query = document.getElementById('search').value.toLowerCase();
        
        filteredEvents = allEvents.filter(e => {
            const isFav = myKeywords.some(k => e.title.includes(k));
            const isNew = !readEvents.includes(e.url);
            
            // 1. æœå°‹
            if (query && !e.title.toLowerCase().includes(query)) return false;

            // 2. å¹³å° (OR) - è‹¥æœ‰é¸ï¼Œå‰‡å¿…é ˆåŒ…å«
            if (filters.platforms.size > 0 && !filters.platforms.has(e.platform)) return false;

            // 3. é¡åˆ¥ (OR)
            if (filters.types.size > 0 && !filters.types.has(e.type)) return false;

            // 4. ç‹€æ…‹ (AND) - é€™æ˜¯é—œéµä¿®æ”¹
            if (filters.status.has('isNew') && !isNew) return false;
            if (filters.status.has('isFav') && !isFav) return false;

            return true;
        });

        renderList();
        renderPagination();
    }

    function renderList() {
        const start = (currentPage - 1) * PAGE_SIZE;
        const pageData = filteredEvents.slice(start, start + PAGE_SIZE);
        
        const list = document.getElementById('event-list');
        if(pageData.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ´»å‹• ğŸ¢</div>';
            return;
        }

        list.innerHTML = pageData.map(e => {
            const isFav = myKeywords.some(k => e.title.includes(k));
            const isNew = !readEvents.includes(e.url);
            return `
                <div class="card ${!isNew ? 'read' : ''}" onclick="window.open('${e.url}', '_blank'); markRead('${e.url}')">
                    ${e.img_url ? `<img src="${e.img_url}" class="card-img" loading="lazy">` : ''}
                    <div class="card-info">
                        <div class="badges">
                            <span class="badge" style="color:#60a5fa">${e.platform}</span>
                            ${isNew ? '<span class="badge new">NEW</span>' : ''}
                            ${isFav ? '<span class="badge fav">â­ é—œæ³¨</span>' : ''}
                            <span class="badge">${e.type}</span>
                        </div>
                        <div style="font-weight:500; font-size:1rem;">${e.title}</div>
                        <div style="font-size:0.8rem; color:#888;">${e.date}</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderPagination() {
        const totalPages = Math.ceil(filteredEvents.length / PAGE_SIZE) || 1;
        document.getElementById('page-info').textContent = `ç¬¬ ${currentPage} / ${totalPages} é  (å…± ${filteredEvents.length} ç­†)`;
        document.getElementById('prev-btn').disabled = currentPage === 1;
        document.getElementById('next-btn').disabled = currentPage === totalPages;
    }

    function changePage(delta) {
        currentPage += delta;
        renderList();
        renderPagination();
        window.scrollTo(0, 0); // æ›é å¾Œå›åˆ°é ‚éƒ¨
    }

    function markRead(url) {
        if(!readEvents.includes(url)) {
            readEvents.push(url);
            localStorage.setItem('readEvents', JSON.stringify(readEvents));
            // é€™è£¡å¯ä»¥é¸æ“‡ä¸é‡æ–°æ¸²æŸ“ï¼Œä»¥å…åˆ—è¡¨è·³å‹•ï¼Œæˆ–è€…åƒ…æ›´æ–°æ¨£å¼
        }
    }

    // åˆå§‹åŒ–
    init();
</script>
</body>
</html>
